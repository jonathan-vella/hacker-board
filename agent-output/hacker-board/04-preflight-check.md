# Step 4b: Pre-Flight AVM Check ‚Äî hacker-board

![Step](https://img.shields.io/badge/Step-4b-blue)
![Status](https://img.shields.io/badge/Status-PASS-brightgreen)
![Agent](https://img.shields.io/badge/Agent-Bicep%20Code-purple)

<details>
<summary><strong>üìë Table of Contents</strong></summary>

- [Purpose](#purpose)
- [AVM Schema Validation Results](#avm-schema-validation-results)
- [Parameter Type Analysis](#parameter-type-analysis)
- [Region Limitations Identified](#region-limitations-identified)
- [Pitfalls Checklist](#pitfalls-checklist)
- [Ready for Implementation](#ready-for-implementation)

</details>

> Generated by bicep-code agent | 2026-02-23
> Status: **PASS ‚Äî all AVM modules validated, no blockers**

| ‚¨ÖÔ∏è Previous                                            | üìë Index            | Next ‚û°Ô∏è                                                          |
| ------------------------------------------------------ | ------------------- | ---------------------------------------------------------------- |
| [04-implementation-plan.md](04-implementation-plan.md) | [README](README.md) | [05-implementation-reference.md](05-implementation-reference.md) |

## Purpose

> [!IMPORTANT]
> This checkpoint validates AVM module schemas BEFORE Bicep code generation.

Prevents:

- Parameter type mismatches (string vs int)
- Deprecated parameter usage
- Region availability issues
- Object structure errors

**Source:** Validated against the live `infra/main.bicep` and 8 modules in `infra/modules/`. No separate implementation plan artifact exists ‚Äî the Bicep files themselves are the implementation.

## AVM Schema Validation Results

```mermaid
%%{init: {'theme':'neutral'}}%%
flowchart LR
    A["Discover AVM\nModules"] --> B["Validate\nSchema"]
    B --> C["Check\nParameters"]
    C --> D["Verify\nRegions"]
    D --> E{"Pass?"}
    E -- Yes --> F["‚úÖ Ready"]
    style F fill:#107C10,color:#fff
```

All 9 AVM modules confirmed available. All are at the **latest published version** as of 2026-02-23.

| #   | Resource                  | Module                          | AVM Module Path                                    | In-Use Version | Latest Version | Status    |
| --- | ------------------------- | ------------------------------- | -------------------------------------------------- | -------------- | -------------- | --------- |
| 1   | Log Analytics Workspace   | `log-analytics.bicep`           | `br/public:avm/res/operational-insights/workspace` | `0.15.0`       | `0.15.0`       | ‚úÖ Latest |
| 2   | Application Insights      | `app-insights.bicep`            | `br/public:avm/res/insights/component`             | `0.7.1`        | `0.7.1`        | ‚úÖ Latest |
| 3   | Cosmos DB Account         | `cosmos-account.bicep`          | `br/public:avm/res/document-db/database-account`   | `0.18.0`       | `0.18.0`       | ‚úÖ Latest |
| 4   | Virtual Network           | `networking.bicep`              | `br/public:avm/res/network/virtual-network`        | `0.7.2`        | `0.7.2`        | ‚úÖ Latest |
| 5   | Private DNS Zone          | `cosmos-private-endpoint.bicep` | `br/public:avm/res/network/private-dns-zone`       | `0.8.0`        | `0.8.0`        | ‚úÖ Latest |
| 6   | Private Endpoint          | `cosmos-private-endpoint.bicep` | `br/public:avm/res/network/private-endpoint`       | `0.11.1`       | `0.11.1`       | ‚úÖ Latest |
| 7   | Container Registry        | `acr.bicep`                     | `br/public:avm/res/container-registry/registry`    | `0.10.0`       | `0.10.0`       | ‚úÖ Latest |
| 8   | App Service Plan          | `app-service.bicep`             | `br/public:avm/res/web/serverfarm`                 | `0.7.0`        | `0.7.0`        | ‚úÖ Latest |
| 9   | Web App (Linux Container) | `app-service.bicep`             | `br/public:avm/res/web/site`                       | `0.21.0`       | `0.21.0`       | ‚úÖ Latest |

**Non-AVM resources** (raw Bicep ‚Äî no AVM module available):

| Resource                      | Module                       | Reason                                                                                                                                                                     |
| ----------------------------- | ---------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Cosmos DB SQL Role Assignment | `cosmos-rbac.bicep`          | Data-plane role assignment; AVM sub-module `sql-role-assignment` exists but is a child resource pattern, not a standalone module. Current raw-Bicep approach is idiomatic. |
| ACR Pull Role Assignment      | `app-service.bicep` (inline) | Standard `Microsoft.Authorization/roleAssignments` ‚Äî no AVM wrapper needed for individual RBAC assignments.                                                                |

## Parameter Type Analysis

<details>
<summary><strong>‚úÖ Log Analytics Workspace ‚Äî dailyQuotaGb type verified</strong></summary>

| Parameter       | In-Use Value      | In-Use Type | ARM Schema Type | AVM Param Type   | Match? |
| --------------- | ----------------- | ----------- | --------------- | ---------------- | ------ |
| `name`          | `'law-${suffix}'` | `string`    | `string`        | `string`         | ‚úÖ     |
| `location`      | `location`        | `string`    | `string`        | `string`         | ‚úÖ     |
| `tags`          | `tags`            | `object`    | `object`        | `object`         | ‚úÖ     |
| `skuName`       | `'PerGB2018'`     | `string`    | `string`        | `string`         | ‚úÖ     |
| `dataRetention` | `30`              | `int`       | `int`           | `int`            | ‚úÖ     |
| `dailyQuotaGb`  | `'1'`             | `string`    | `int`           | `null \| string` | ‚úÖ     |

**Note:** The underlying ARM schema declares `dailyQuotaGb` as `int`, but the AVM module (`operational-insights/workspace:0.15.0`) wraps it as `null | string`. The string value `'1'` is correct for the AVM parameter type. The AVM module handles the int conversion internally. Confirmed via `bicep build` ‚Äî passes cleanly.

</details>

<details>
<summary><strong>‚úÖ Application Insights</strong></summary>

| Parameter             | In-Use Value                      | Expected Type | Match? |
| --------------------- | --------------------------------- | ------------- | ------ |
| `name`                | `'appi-${suffix}'`                | `string`      | ‚úÖ     |
| `location`            | `location`                        | `string`      | ‚úÖ     |
| `tags`                | `tags`                            | `object`      | ‚úÖ     |
| `kind`                | `'web'`                           | `string`      | ‚úÖ     |
| `applicationType`     | `'web'`                           | `string`      | ‚úÖ     |
| `workspaceResourceId` | `logAnalytics.outputs.resourceId` | `string`      | ‚úÖ     |
| `retentionInDays`     | `30`                              | `int`         | ‚úÖ     |

No issues found.

</details>

<details>
<summary><strong>‚úÖ Cosmos DB Account (Serverless)</strong></summary>

| Parameter                    | In-Use Value                          | Expected Type | Match? |
| ---------------------------- | ------------------------------------- | ------------- | ------ |
| `name`                       | `'cosmos-${suffix}'`                  | `string`      | ‚úÖ     |
| `databaseAccountOfferType`   | `'Standard'`                          | `string`      | ‚úÖ     |
| `capabilitiesToAdd`          | `['EnableServerless']`                | `string[]`    | ‚úÖ     |
| `disableLocalAuthentication` | `true`                                | `bool`        | ‚úÖ     |
| `minimumTlsVersion`          | `'Tls12'`                             | `string`      | ‚úÖ     |
| `networkRestrictions`        | `{ publicNetworkAccess: 'Disabled' }` | `object`      | ‚úÖ     |
| `failoverLocations`          | `[{...}]`                             | `array`       | ‚úÖ     |
| `sqlDatabases`               | `[{name, containers}]`                | `array`       | ‚úÖ     |

No issues found. `enableAutomaticFailover: false` is correct for Serverless (single-region only).

</details>

<details>
<summary><strong>‚úÖ Virtual Network</strong></summary>

| Parameter         | In-Use Value                          | Expected Type | Match? |
| ----------------- | ------------------------------------- | ------------- | ------ |
| `name`            | `vnetName`                            | `string`      | ‚úÖ     |
| `addressPrefixes` | `[addressPrefix]`                     | `string[]`    | ‚úÖ     |
| `subnets`         | `[{name, addressPrefix, delegation}]` | `array`       | ‚úÖ     |

Subnet delegation uses `'Microsoft.Web/serverFarms'` string shorthand ‚Äî confirmed valid in AVM `virtual-network:0.7.2`.

</details>

<details>
<summary><strong>‚úÖ Private DNS Zone + Private Endpoint</strong></summary>

| Parameter                                           | Expected Type      | Match? |
| --------------------------------------------------- | ------------------ | ------ |
| DNS Zone `name` (`privatelink.documents.azure.com`) | `string`           | ‚úÖ     |
| `virtualNetworkLinks`                               | `array` of objects | ‚úÖ     |
| PE `subnetResourceId`                               | `string`           | ‚úÖ     |
| PE `privateLinkServiceConnections`                  | `array`            | ‚úÖ     |
| PE `privateDnsZoneGroup`                            | `object`           | ‚úÖ     |

No issues found.

</details>

<details>
<summary><strong>‚úÖ Container Registry</strong></summary>

| Parameter              | In-Use Value | Expected Type | Match? |
| ---------------------- | ------------ | ------------- | ------ |
| `acrSku`               | `'Standard'` | `string`      | ‚úÖ     |
| `publicNetworkAccess`  | `'Enabled'`  | `string`      | ‚úÖ     |
| `anonymousPullEnabled` | `false`      | `bool`        | ‚úÖ     |
| `acrAdminUserEnabled`  | `false`      | `bool`        | ‚úÖ     |

No issues found. Admin user disabled; App Service uses MI-based acrPull.

</details>

<details>
<summary><strong>‚úÖ App Service Plan</strong></summary>

| Parameter     | In-Use Value | Expected Type | Match? |
| ------------- | ------------ | ------------- | ------ |
| `kind`        | `'Linux'`    | `string`      | ‚úÖ     |
| `reserved`    | `true`       | `bool`        | ‚úÖ     |
| `skuName`     | `'S1'`       | `string`      | ‚úÖ     |
| `skuCapacity` | `1`          | `int`         | ‚úÖ     |

No issues found. S1 supports VNet integration.

</details>

<details>
<summary><strong>‚úÖ Web App (site:0.21.0)</strong></summary>

Key parameters validated:

| Parameter              | In-Use Value                                             | Expected Type | Match? |
| ---------------------- | -------------------------------------------------------- | ------------- | ------ |
| `kind`                 | `'app,linux,container'`                                  | `string`      | ‚úÖ     |
| `serverFarmResourceId` | `appServicePlan.outputs.resourceId`                      | `string`      | ‚úÖ     |
| `managedIdentities`    | `{ systemAssigned: true }`                               | `object`      | ‚úÖ     |
| `httpsOnly`            | `true`                                                   | `bool`        | ‚úÖ     |
| `siteConfig`           | `{...}`                                                  | `object`      | ‚úÖ     |
| `configs`              | `[{name:'appsettings',...},{name:'authsettingsV2',...}]` | `array`       | ‚úÖ     |

Uses `configs` array (AVM 0.21.0 pattern) instead of deprecated `appSettingsKeyValuePairs`. ‚úÖ
Uses `APPLICATIONINSIGHTS_CONNECTION_STRING` (not deprecated `APPINSIGHTS_INSTRUMENTATIONKEY`). ‚úÖ

</details>

## Region Limitations Identified

| Resource       | Default Region | Limitation                                                         | Action        |
| -------------- | -------------- | ------------------------------------------------------------------ | ------------- |
| All resources  | `centralus`    | No limitations ‚Äî all 9 resource types are available in `centralus` | None required |
| Static Web App | N/A            | Not used in this project                                           | N/A           |
| Azure OpenAI   | N/A            | Not used in this project                                           | N/A           |

**Allowed regions** (from `main.bicep`): `centralus`, `eastus`, `eastus2`, `westus2`, `westus3`, `northeurope`, `westeurope`, `uksouth`, `swedencentral`, `eastasia`, `southeastasia`, `japaneast`, `australiaeast`, `southcentralus`, `brazilsouth`.

All 9 resource types (App Service, ACR, Cosmos DB, VNet, Private Endpoint, Private DNS Zone, Log Analytics, App Insights) are available in every listed region. No region blockers.

## Pitfalls Checklist

Based on [Azure Defaults Skill](../../.github/skills/azure-defaults/SKILL.md):

- [x] Log Analytics `dailyQuotaGb` uses correct type ‚Äî ‚úÖ AVM module declares `null | string`; string `'1'` is correct
- [x] Container App Environment uses `appLogsConfiguration` object ‚Äî N/A (not used)
- [x] Container App uses `scaleSettings` object (not flat params) ‚Äî N/A (not used)
- [x] SQL Server uses `sku` object + `availabilityZone: -1` ‚Äî N/A (not used)
- [x] App Service uses connection string (not deprecated instrumentation key) ‚Äî ‚úÖ Uses `APPLICATIONINSIGHTS_CONNECTION_STRING`
- [x] Static Web App location hardcoded to supported region ‚Äî N/A (not used)

### Additional Checks (HackerBoard-specific)

- [x] **Unique suffix**: `uniqueSuffix` parameter added, derived from `uniqueString(resourceGroup().id)`, deterministic and repeatable ‚úÖ
- [x] **ACR name length**: `cr` + `hackerboard` (11) + `prod` (4) + suffix (6) = 23 chars (limit: 50) ‚úÖ
- [x] **Cosmos name length**: `cosmos-hacker-board-prod-` + suffix (6) = 31 chars (limit: 44) ‚úÖ
- [x] **App name length**: `app-hacker-board-prod-` + suffix (6) = 28 chars (limit: 60) ‚úÖ
- [x] **VNet name length**: `vnet-hacker-board-prod-` + suffix (6) = 29 chars (limit: 64) ‚úÖ
- [x] **No hardcoded admin identities** in `.bicepparam` or Bicep defaults ‚úÖ
- [x] **TLS 1.2 enforced**: Cosmos DB `minimumTlsVersion: 'Tls12'`, App Service `minTlsVersion: '1.2'` ‚úÖ
- [x] **HTTPS only**: App Service `httpsOnly: true` ‚úÖ
- [x] **Public access disabled**: Cosmos DB `publicNetworkAccess: 'Disabled'` ‚úÖ
- [x] **Managed Identity**: System-assigned MI for App Service, `acrUseManagedIdentityCreds: true` ‚úÖ
- [x] **Local auth disabled**: Cosmos DB `disableLocalAuthentication: true` ‚úÖ
- [x] **FTP disabled**: App Service `ftpsState: 'Disabled'` ‚úÖ
- [x] **No Key Vault or Storage Account**: No 24-char name constraint issues ‚úÖ

## Ready for Implementation

| Check                       | Status | Notes                                                                        |
| --------------------------- | ------ | ---------------------------------------------------------------------------- |
| All AVM modules verified    | ‚úÖ     | 9/9 at latest versions                                                       |
| Parameter types confirmed   | ‚úÖ     | All parameters match AVM module schemas                                      |
| Region limitations handled  | ‚úÖ     | All resources available in all allowed regions                               |
| Pitfalls addressed          | ‚úÖ     | No deprecated parameters; connection string pattern used correctly           |
| Security baseline           | ‚úÖ     | TLS 1.2, HTTPS-only, MI, no public access, FTP disabled, local auth disabled |
| Naming / length constraints | ‚úÖ     | All names within limits with 6-char suffix                                   |
| No hardcoded identities     | ‚úÖ     | `jonathan-vella` removed from all deployment files                           |

> [!IMPORTANT]
> **Go / No-Go Verdict**
>
> | Signal      | Status                     |
> | ----------- | -------------------------- |
> | AVM Modules | ‚úÖ All 9 at latest         |
> | Parameters  | ‚úÖ All match AVM schemas   |
> | Regions     | ‚úÖ No limitations          |
> | Pitfalls    | ‚úÖ All addressed           |
> | **Overall** | **‚úÖ READY ‚Äî no blockers** |
>
> All 9 AVM modules are at their latest versions, all parameter types match AVM schemas, no region limitations, and all security baselines are in place.

---

_Pre-flight validation for hacker-board Bicep implementation_

---

| ‚¨ÖÔ∏è [04-implementation-plan.md](04-implementation-plan.md) | üè† [Project Index](README.md) | ‚û°Ô∏è [05-implementation-reference.md](05-implementation-reference.md) |
| --------------------------------------------------------- | ----------------------------- | ------------------------------------------------------------------- |
