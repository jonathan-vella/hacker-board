# Step 4b: Pre-Flight AVM Check ‚Äî HackerBoard

![Step](https://img.shields.io/badge/Step-4b-blue)
![Status](https://img.shields.io/badge/Status-Advisory-yellow)
![Agent](https://img.shields.io/badge/Agent-Bicep%20Code-purple)
![Verdict](https://img.shields.io/badge/Verdict-GO%20with%20Advisories-brightgreen)

<details>
<summary><strong>üìë Table of Contents</strong></summary>

- [Purpose](#purpose)
- [AVM Schema Validation Results](#avm-schema-validation-results)
- [Parameter Type Analysis](#parameter-type-analysis)
- [Region Limitations Identified](#region-limitations-identified)
- [Pitfalls Checklist](#pitfalls-checklist)
- [Advisory Items](#advisory-items)
- [Ready for Implementation](#ready-for-implementation)

</details>

> Generated by bicep-code agent | 2026-02-19
> Status: **ADVISORY ‚Äî GO with 3 non-blocking warnings**

| ‚¨ÖÔ∏è Previous                                            | üìë Index            | Next ‚û°Ô∏è                                                          |
| ------------------------------------------------------ | ------------------- | ---------------------------------------------------------------- |
| [04-implementation-plan.md](04-implementation-plan.md) | [README](README.md) | [05-implementation-reference.md](05-implementation-reference.md) |

---

## Purpose

> [!IMPORTANT]
> This checkpoint validates AVM module schemas BEFORE Bicep code generation.

Prevents:

- Parameter type mismatches (string vs int)
- Deprecated parameter usage
- Region availability issues
- Object structure errors
- BCP081 untyped resource warnings

### Validation Scope

| Resource                | File                           | Method                                                      |
| ----------------------- | ------------------------------ | ----------------------------------------------------------- |
| Log Analytics Workspace | `modules/log-analytics.bicep`  | `mcp_bicep_get_bicep_file_diagnostics` + ARM schema         |
| Application Insights    | `modules/app-insights.bicep`   | `mcp_bicep_get_bicep_file_diagnostics`                      |
| Cosmos DB Account       | `modules/cosmos-account.bicep` | `mcp_bicep_get_bicep_file_diagnostics` + ARM schema         |
| Cosmos DB RBAC          | `modules/cosmos-rbac.bicep`    | Direct resource types ‚Äî no AVM needed                       |
| Static Web App          | `modules/static-web-app.bicep` | `mcp_bicep_get_bicep_file_diagnostics`                      |
| Deployment Script       | `modules/entra-app.bicep`      | `mcp_bicep_get_bicep_file_diagnostics` ‚Äî BCP081 fix applied |
| Orchestrator            | `main.bicep`                   | `mcp_bicep_get_bicep_file_diagnostics`                      |

---

## AVM Schema Validation Results

```mermaid
%%{init: {'theme':'neutral'}}%%
flowchart LR
    A["Discover AVM\nModules"] --> B["Validate\nSchema"]
    B --> C["Check\nParameters"]
    C --> D["Verify\nRegions"]
    D --> E{"Pass?"}
    E -- Yes --> F["‚úÖ Advisory\nGO"]
    E -- No --> G["‚ùå Blocked"]
    style F fill:#107C10,color:#fff
    style G fill:#D83B01,color:#fff
```

| #   | Resource                       | AVM Module Path                                                               | Plan Version   | Latest Version | Version Status | Lint    | Notes                                                                        |
| --- | ------------------------------ | ----------------------------------------------------------------------------- | -------------- | -------------- | -------------- | ------- | ---------------------------------------------------------------------------- |
| 1   | User-Assigned Managed Identity | `br/public:avm/res/managed-identity/user-assigned-identity`                   | `0.5.0`        | `0.5.0`        | ‚úÖ Latest      | ‚úÖ PASS | Inline in main.bicep                                                         |
| 2   | Log Analytics Workspace        | `br/public:avm/res/operational-insights/workspace`                            | `0.15.0`       | `0.15.0`       | ‚úÖ Latest      | ‚úÖ PASS | ‚ö†Ô∏è `dailyQuotaGb` string ‚Üí int advisory                                      |
| 3   | Application Insights           | `br/public:avm/res/insights/component`                                        | `0.7.1`        | `0.7.1`        | ‚úÖ Latest      | ‚úÖ PASS | Uses `connectionString` (not deprecated key)                                 |
| 4   | Cosmos DB Account              | `br/public:avm/res/document-db/database-account`                              | `0.18.0`       | `0.18.0`       | ‚úÖ Latest      | ‚úÖ PASS | ‚ö†Ô∏è Name lacks `uniqueSuffix` ‚Äî see advisory                                  |
| 5   | Cosmos DB SQL Role Assignment  | Direct: `Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments@2024-05-15` | N/A            | N/A            | ‚úÖ Fully typed | ‚úÖ PASS | Deliberate: AVM child module unnecessary for single assignment               |
| 6   | Static Web App                 | `br/public:avm/res/web/static-site`                                           | `0.9.3`        | `0.9.3`        | ‚úÖ Latest      | ‚úÖ PASS | ‚ö†Ô∏è `swedencentral` in `@allowed` but SWA unsupported there                   |
| 7   | Deployment Script              | Direct: `Microsoft.Resources/deploymentScripts@2023-08-01`                    | N/A (replaced) | N/A            | ‚úÖ Fully typed | ‚úÖ PASS | Previously `avm/res/resources/deployment-script:0.5.2` ‚Äî BCP081 **resolved** |

**All Bicep lint results (zero errors, zero warnings):**

```text
log-analytics.bicep  ‚Üí []
app-insights.bicep   ‚Üí []
cosmos-account.bicep ‚Üí []
cosmos-rbac.bicep    ‚Üí []
static-web-app.bicep ‚Üí []
entra-app.bicep      ‚Üí []
main.bicep           ‚Üí []
```

---

## Parameter Type Analysis

<details>
<summary><strong>Log Analytics Workspace (`operational-insights/workspace:0.15.0`)</strong></summary>

| Parameter       | Current Value          | AVM Type | ARM Schema Type | Status      | Action                                  |
| --------------- | ---------------------- | -------- | --------------- | ----------- | --------------------------------------- |
| `skuName`       | `'PerGB2018'`          | `string` | `string`        | ‚úÖ OK       | None                                    |
| `dataRetention` | `30`                   | `int`    | `int`           | ‚úÖ OK       | None                                    |
| `dailyQuotaGb`  | `'1'` (string literal) | `int`    | `int`           | ‚ö†Ô∏è Advisory | Change to `1` (int) or `-1` (unlimited) |

**Evidence**: ARM resource schema `Microsoft.OperationalInsights/workspaces@2023-09-01` defines `WorkspaceCapping.dailyQuotaGb` as `int`. Bicep linter passes (AVM may accept coercible literals), but the type mismatch is a known pitfall per azure-defaults skill. Recommend aligning to `int` to prevent unexpected behavior on strict ARM deployments.

**Recommended fix:**

```bicep
// modules/log-analytics.bicep ‚Äî line 22
dailyQuotaGb: -1  // -1 = no quota cap (or use 1 for 1 GB/day integer)
```

</details>

<details>
<summary><strong>Cosmos DB Account (`document-db/database-account:0.18.0`)</strong></summary>

| Parameter                    | Current Value                                         | AVM Type   | ARM Schema Type                   | Status            |
| ---------------------------- | ----------------------------------------------------- | ---------- | --------------------------------- | ----------------- |
| `databaseAccountOfferType`   | `'Standard'`                                          | `string`   | `Standard` (Required)             | ‚úÖ OK             |
| `capabilitiesToAdd`          | `['EnableServerless']`                                | `string[]` | `Capability[]` (AVM flattens)     | ‚úÖ OK             |
| `disableLocalAuthentication` | `true`                                                | `bool`     | ARM: `disableLocalAuth: bool`     | ‚úÖ OK ‚Äî AVM alias |
| `enableAutomaticFailover`    | `false`                                               | `bool`     | `bool`                            | ‚úÖ OK             |
| `minimumTlsVersion`          | `'Tls12'`                                             | `string`   | `Tls \| Tls11 \| Tls12 \| string` | ‚úÖ OK             |
| `failoverLocations`          | `[{locationName, failoverPriority, isZoneRedundant}]` | `object[]` | `Location[]`                      | ‚úÖ OK             |
| `sqlDatabases`               | Array with containers                                 | `object[]` | child resource                    | ‚úÖ OK             |

All Cosmos DB parameters compile cleanly against AVM 0.18.0.

</details>

<details>
<summary><strong>Application Insights (`insights/component:0.7.1`)</strong></summary>

| Parameter                  | Current Value                   | Status                     |
| -------------------------- | ------------------------------- | -------------------------- |
| `kind`                     | `'web'`                         | ‚úÖ OK                      |
| `applicationType`          | `'web'`                         | ‚úÖ OK                      |
| `workspaceResourceId`      | Log Analytics output            | ‚úÖ OK                      |
| `retentionInDays`          | `30`                            | ‚úÖ OK                      |
| Output: `connectionString` | Used (not `instrumentationKey`) | ‚úÖ No deprecated key usage |

</details>

<details>
<summary><strong>Static Web App (`web/static-site:0.9.3`)</strong></summary>

| Parameter                             | Current Value                                                          | Status                                        |
| ------------------------------------- | ---------------------------------------------------------------------- | --------------------------------------------- |
| `sku`                                 | `'Standard'`                                                           | ‚úÖ OK ‚Äî Standard required for ARM reliability |
| `managedIdentities.systemAssigned`    | `true`                                                                 | ‚úÖ OK                                         |
| `appSettings`                         | Object with `APPLICATIONINSIGHTS_CONNECTION_STRING`, `COSMOS_ENDPOINT` | ‚úÖ OK ‚Äî no deprecated keys                    |
| `stagingEnvironmentPolicy`            | `'Disabled'`                                                           | ‚úÖ OK                                         |
| Output: `systemAssignedMIPrincipalId` | Read via safe-navigation `?.`                                          | ‚úÖ OK                                         |

</details>

<details>
<summary><strong>Deployment Script (direct `@2023-08-01`)</strong></summary>

| Parameter                         | Current Value         | ARM Schema Type                                 | Status                                         |
| --------------------------------- | --------------------- | ----------------------------------------------- | ---------------------------------------------- |
| `kind`                            | `'AzurePowerShell'`   | discriminator                                   | ‚úÖ OK                                          |
| `identity.type`                   | `'UserAssigned'`      | `string`                                        | ‚úÖ OK                                          |
| `properties.azPowerShellVersion`  | `'12.3'`              | `string` (Required)                             | ‚úÖ OK                                          |
| `properties.retentionInterval`    | `'PT1H'`              | `string` (Required, ISO 8601)                   | ‚úÖ OK                                          |
| `properties.cleanupPreference`    | `'OnSuccess'`         | `Always \| OnSuccess \| OnExpiration \| string` | ‚úÖ OK                                          |
| `properties.forceUpdateTag`       | `deploymentTimestamp` | `string`                                        | ‚úÖ OK ‚Äî replaces `arguments` for cache-busting |
| `properties.environmentVariables` | `[{name, value}]`     | `EnvironmentVariable[]`                         | ‚úÖ OK                                          |
| `properties.scriptContent`        | PowerShell heredoc    | `string`                                        | ‚úÖ OK                                          |

**BCP081 Fix**: The plan specified `avm/res/resources/deployment-script:0.5.2` which internally uses `Microsoft.Resources/deploymentScripts@2021-12-01` ‚Äî an API version with no Bicep type definitions (BCP081). This was replaced with the direct resource declaration at `@2023-08-01` (fully typed). Zero diagnostics confirmed.

</details>

---

## Region Limitations Identified

> **Note**: Phase 18 migrated from SWA to App Service + ACR. The SWA region limitations below are historical. App Service and ACR are available in all primary Azure regions including `centralus`.

| Resource                       | Current Config                        | Limitation                                      | Risk    | Action |
| ------------------------------ | ------------------------------------- | ----------------------------------------------- | ------- | ------ |
| App Service (Web App)          | `location` param, default `centralus` | Available in all primary regions                | ‚úÖ None | None   |
| Container Registry             | `location` param, default `centralus` | Available in all primary regions                | ‚úÖ None | None   |
| Cosmos DB Account (Serverless) | `location` param, default `centralus` | Serverless available in all primary regions     | ‚úÖ None | None   |
| Log Analytics                  | `location` param                      | Available in `centralus` and all target regions | ‚úÖ None | None   |
| Application Insights           | `location` param                      | Available in all target regions                 | ‚úÖ None | None   |

**App Service + ACR Region Support** (Phase 18 ‚Äî all primary regions supported):

| Region          | Available        |
| --------------- | ---------------- |
| `centralus`     | ‚úÖ Yes (default) |
| `eastus`        | ‚úÖ Yes           |
| `eastus2`       | ‚úÖ Yes           |
| `westus2`       | ‚úÖ Yes           |
| `westus3`       | ‚úÖ Yes           |
| `swedencentral` | ‚úÖ Yes           |
| `westeurope`    | ‚úÖ Yes           |

---

## Pitfalls Checklist

Based on [Azure Defaults Skill](../../.github/skills/azure-defaults/SKILL.md) known pitfalls:

| Pitfall                                                                                       | Applies? | Status      | Notes                                                          |
| --------------------------------------------------------------------------------------------- | -------- | ----------- | -------------------------------------------------------------- |
| Log Analytics `dailyQuotaGb` uses int (not string)                                            | ‚úÖ Yes   | ‚ö†Ô∏è Advisory | Currently `'1'` (string) ‚Äî recommend `1` (int) or `-1`         |
| Container App Environment uses `logsConfiguration` (not deprecated `appLogsConfiguration`)    | ‚ùå N/A   | N/A         | No Container Apps in scope                                     |
| Container App uses `scaleSettings` object                                                     | ‚ùå N/A   | N/A         | No Container Apps in scope                                     |
| SQL Server uses `sku` object + `availabilityZone: -1`                                         | ‚ùå N/A   | N/A         | SQL removed (Cosmos DB migration)                              |
| App Service uses `APPLICATIONINSIGHTS_CONNECTION_STRING` (not deprecated instrumentation key) | ‚úÖ Yes   | ‚úÖ PASS     | `connectionString` output used throughout                      |
| Static Web App location hardcoded to supported region                                         | ‚ùå N/A   | N/A         | SWA removed in Phase 18; App Service has no region limitations |
| Key Vault `softDeleteRetentionInDays` immutable                                               | ‚ùå N/A   | N/A         | No Key Vault in scope                                          |
| Static Web App `Standard` SKU for reliable ARM                                                | ‚ùå N/A   | N/A         | SWA removed in Phase 18                                        |
| `APPINSIGHTS_INSTRUMENTATIONKEY` deprecated                                                   | ‚úÖ Yes   | ‚úÖ PASS     | Not used anywhere ‚Äî `connectionString` used                    |
| Globally unique names need `uniqueSuffix`                                                     | ‚úÖ Yes   | ‚ö†Ô∏è Advisory | Cosmos DB name `cosmos-hacker-board-prod` lacks suffix         |
| Deployment Script AVM BCP081 (`@2021-12-01` untyped)                                          | ‚úÖ Yes   | ‚úÖ RESOLVED | Fixed: direct `@2023-08-01` resource                           |

---

## Advisory Items

Three non-blocking advisories identified. None prevent deployment, but each should be addressed before production.

### Advisory 1 ‚Äî `dailyQuotaGb` Type Mismatch (LOW)

**File**: `infra/modules/log-analytics.bicep`, line 22
**Issue**: `dailyQuotaGb: '1'` passes a string literal where the ARM resource schema defines `int`.
**Risk**: May cause unexpected behavior on strict ARM validation or future AVM module upgrades.
**Fix**:

```bicep
// BEFORE:
dailyQuotaGb: '1'

// AFTER (no quota cap):
dailyQuotaGb: -1

// AFTER (1 GB/day cap):
dailyQuotaGb: 1
```

---

### Advisory 2 ‚Äî ~~`swedencentral` in SWA `@allowed` List~~ (RESOLVED)

> **Phase 18**: SWA removed. App Service + ACR are available in all `@allowed` regions including `swedencentral`. This advisory no longer applies.

---

### Advisory 3 ‚Äî Cosmos DB Name Lacks `uniqueSuffix` (MEDIUM)

**File**: `infra/main.bicep`, line 131 (`name: 'cosmos-${suffix}'`)
**Issue**: Cosmos DB account names must be globally unique across all Azure subscriptions. `cosmos-hacker-board-prod` is a predictable name that could be claimed by another tenant.
**Risk**: Name collision on fresh deployment to a new subscription ‚Äî `Conflict (409)` from ARM.
**CAF Pattern**:

```bicep
// In main.bicep variables block:
var uniqueSuffix = take(uniqueString(resourceGroup().id), 6)

// In cosmosAccount module params:
name: 'cosmos-${suffix}-${uniqueSuffix}'   // e.g. cosmos-hacker-board-prod-a1b2c3
```

> **Note**: The existing deployment to subscription `noalz` is unaffected (the current name is already reserved). This fix matters for fresh deployments to new resource groups.

---

## Ready for Implementation

| Check                                  | Status      | Detail                                                       |
| -------------------------------------- | ----------- | ------------------------------------------------------------ |
| All AVM modules at latest version      | ‚úÖ Ready    | All 6 modules verified against MCR registry                  |
| Bicep lint passes (zero errors)        | ‚úÖ Ready    | 7 files ‚Äî zero diagnostics each                              |
| BCP081 resolved                        | ‚úÖ Ready    | Deployment Script replaced with typed `@2023-08-01`          |
| Parameter types confirmed              | ‚úÖ Ready    | All params match AVM schemas ‚Äî `dailyQuotaGb` advisory only  |
| Region limitations handled             | ‚ö†Ô∏è Advisory | Default region safe; `swedencentral` in allowed-list is risk |
| Pitfalls addressed                     | ‚ö†Ô∏è Advisory | 3 low/medium advisories documented above                     |
| Governance constraints reflected       | ‚úÖ Ready    | `disableLocalAuth: true`, 9 tags all set                     |
| Cosmos DB RBAC correct                 | ‚úÖ Ready    | Direct resource type, idempotent GUID, correct role ID       |
| App Insights connection string pattern | ‚úÖ Ready    | No deprecated instrumentation key usage                      |

> [!IMPORTANT]
> **Go / No-Go Verdict**
>
> | Signal             | Status               | Detail                                                      |
> | ------------------ | -------------------- | ----------------------------------------------------------- |
> | AVM Modules        | ‚úÖ PASS              | All at latest version                                       |
> | Lint / Diagnostics | ‚úÖ PASS              | Zero errors across all files                                |
> | BCP081             | ‚úÖ RESOLVED          | entra-app.bicep fixed                                       |
> | Parameter Types    | ‚úÖ PASS              | `dailyQuotaGb` advisory (non-blocking)                      |
> | Regions            | ‚ö†Ô∏è ADVISORY          | Remove `swedencentral` from `@allowed`                      |
> | Unique Names       | ‚ö†Ô∏è ADVISORY          | Add `uniqueSuffix` to Cosmos DB name                        |
> | **Overall**        | **‚úÖ GO ‚Äî ADVISORY** | Proceed to implementation; apply advisories as time permits |
>
> No hard blockers. All 3 advisories are safe to defer until post-deployment cleanup, but applying them now is recommended.

---

_Pre-flight validation for HackerBoard Bicep implementation ‚Äî completed 2026-02-19_

---

| ‚¨ÖÔ∏è [04-implementation-plan.md](04-implementation-plan.md) | üè† [Project Index](README.md) | ‚û°Ô∏è [05-implementation-reference.md](05-implementation-reference.md) |
| --------------------------------------------------------- | ----------------------------- | ------------------------------------------------------------------- |
