# Step 4: Implementation Plan ‚Äî HackerBoard (Phase 18.4: App Service + ACR Migration)

![Step](https://img.shields.io/badge/Step-4-blue)
![Status](https://img.shields.io/badge/Status-Draft-orange)
![Agent](https://img.shields.io/badge/Agent-Bicep%20Plan-purple)
![Date](https://img.shields.io/badge/Generated-2026--02--20-grey)

<details>
<summary><strong>üìë Table of Contents</strong></summary>

- [Overview](#overview)
- [Resource Inventory](#resource-inventory)
- [Module Structure](#module-structure)
- [Implementation Tasks](#implementation-tasks)
- [Deployment Phases](#deployment-phases)
- [Dependency Graph](#dependency-graph)
- [Runtime Flow Diagram](#runtime-flow-diagram)
- [Naming Conventions](#naming-conventions)
- [Security Configuration](#security-configuration)
- [Estimated Implementation Time](#estimated-implementation-time)
- [Approval Gate](#approval-gate)
- [References](#references)

</details>

> Generated by bicep-plan agent | 2026-02-20

| ‚¨ÖÔ∏è Previous                                                  | üìë Index            | Next ‚û°Ô∏è                                        |
| ------------------------------------------------------------ | ------------------- | ---------------------------------------------- |
| [04-governance-constraints.md](04-governance-constraints.md) | [README](README.md) | [04-preflight-check.md](04-preflight-check.md) |

---

## Overview

> **Subscription**: noalz (`00858ffc-dded-4f0f-8bbf-e17fff0d47d9`)
> **Tenant**: Lord of the Cloud (`2d04cb4c-999b-4e60-a3a7-e8993edc768b`)
> **Deployment Strategy**: Phased (4 phases ‚Äî Phases 1‚Äì2 already deployed) | **Est. Implementation**: ~2.5 hours

This plan replaces the **Azure Static Web App** module with **Azure App Service for Linux Containers** + **Azure Container Registry (ACR)**, addressing the SWA managed identity sidecar `expires_on` bug that makes Cosmos DB MI authentication unreliable. The Express adapter pattern (Steps 18.1‚Äì18.3) wraps existing Azure Functions handlers without modifying business logic; this plan covers **Step 18.4 ‚Äî Bicep infrastructure changes only**.

### Decisions

| ID  | Decision                                                                   |
| --- | -------------------------------------------------------------------------- |
| D28 | Replace SWA with App Service for Linux Containers + ACR                    |
| D29 | Express adapter wraps existing Functions handlers unchanged                |
| D30 | App Service Easy Auth for GitHub OAuth ‚Äî same `/.auth/*` + header contract |

### What Changes (Infrastructure)

| Area               | Before (SWA)                               | After (App Service + ACR)                                              |
| ------------------ | ------------------------------------------ | ---------------------------------------------------------------------- |
| Compute            | SWA Standard (`Microsoft.Web/staticSites`) | App Service Plan B1 Linux + Web App for Containers                     |
| Container registry | N/A (SWA builds internally)                | ACR Basic (`Microsoft.ContainerRegistry/registries`)                   |
| Auth               | SWA built-in auth (config-driven)          | App Service Easy Auth (`authsettingsV2`) ‚Äî same `/.auth/*` contract    |
| Managed identity   | SWA system-assigned MI (broken sidecar)    | App Service system-assigned MI (battle-tested)                         |
| Image pull         | N/A                                        | `acrPull` role assignment ‚Äî MI-based, no admin credentials             |
| Cosmos RBAC        | SWA MI ‚Üí Cosmos Data Contributor           | App Service MI ‚Üí Cosmos Data Contributor (same role, different caller) |

### What Stays Unchanged

| Resource                       | AVM Module                               | Version | Notes                                       |
| ------------------------------ | ---------------------------------------- | ------- | ------------------------------------------- |
| Log Analytics Workspace        | `avm/res/operational-insights/workspace` | 0.15.0  | No changes                                  |
| Application Insights           | `avm/res/insights/component`             | 0.7.1   | No changes                                  |
| Cosmos DB Account (Serverless) | `avm/res/document-db/database-account`   | 0.18.0  | No changes                                  |
| Cosmos DB RBAC module          | Native Bicep resource                    | ‚Äî       | Same contract, different principalId source |

---

## Resource Inventory

| Resource                | Type                                          | SKU / Tier   | AVM Status | AVM Module                               | Version  | Dependencies                   | Status      |
| ----------------------- | --------------------------------------------- | ------------ | ---------- | ---------------------------------------- | -------- | ------------------------------ | ----------- |
| Log Analytics Workspace | `Microsoft.OperationalInsights/workspaces`    | PerGB2018    | ‚úÖ AVM     | `avm/res/operational-insights/workspace` | `0.15.0` | ‚Äî                              | ‚úÖ Deployed |
| Application Insights    | `Microsoft.Insights/components`               | web          | ‚úÖ AVM     | `avm/res/insights/component`             | `0.7.1`  | Log Analytics                  | ‚úÖ Deployed |
| Cosmos DB Account       | `Microsoft.DocumentDB/databaseAccounts`       | Serverless   | ‚úÖ AVM     | `avm/res/document-db/database-account`   | `0.18.0` | ‚Äî                              | ‚úÖ Deployed |
| **Container Registry**  | `Microsoft.ContainerRegistry/registries`      | **Basic**    | ‚úÖ AVM     | `avm/res/container-registry/registry`    | `0.10.0` | ‚Äî                              | ‚¨ú New      |
| **App Service Plan**    | `Microsoft.Web/serverfarms`                   | **B1 Linux** | ‚úÖ AVM     | `avm/res/web/serverfarm`                 | `0.7.0`  | ‚Äî                              | ‚¨ú New      |
| **Web App (Container)** | `Microsoft.Web/sites`                         | Linux        | ‚úÖ AVM     | `avm/res/web/site`                       | `0.21.0` | ASP, ACR, Cosmos, App Insights | ‚¨ú New      |
| **ACR Pull Role**       | `Microsoft.Authorization/roleAssignments`     | ‚Äî            | ‚ùå Native  | (simple role assignment)                 | ‚Äî        | ACR, Web App MI                | ‚¨ú New      |
| Cosmos DB RBAC          | `Microsoft.DocumentDB/.../sqlRoleAssignments` | ‚Äî            | ‚ùå Native  | (Cosmos data-plane RBAC)                 | ‚Äî        | Cosmos DB, Web App MI          | üîÑ Modified |

> **AVM coverage**: 6 of 8 resources use AVM modules. The 2 native resources are simple role assignments where AVM would add unnecessary complexity.

---

## Module Structure

```text
infra/
‚îú‚îÄ‚îÄ main.bicep              ‚Üê MODIFY (replace SWA module, add ACR + App Service)
‚îú‚îÄ‚îÄ main.bicepparam         ‚Üê MODIFY (new OAuth + container params, remove SWA params)
‚îú‚îÄ‚îÄ azuredeploy.json        ‚Üê REBUILD (az bicep build)
‚îú‚îÄ‚îÄ deploy.ps1              ‚Üê MODIFY (separate Phase 18.6)
‚îî‚îÄ‚îÄ modules/
    ‚îú‚îÄ‚îÄ log-analytics.bicep     NO CHANGE
    ‚îú‚îÄ‚îÄ app-insights.bicep      NO CHANGE
    ‚îú‚îÄ‚îÄ cosmos-account.bicep    NO CHANGE
    ‚îú‚îÄ‚îÄ cosmos-rbac.bicep       NO CHANGE (same interface, different principalId source)
    ‚îú‚îÄ‚îÄ acr.bicep               NEW ‚Äî ACR Basic via AVM
    ‚îú‚îÄ‚îÄ app-service.bicep       NEW ‚Äî ASP B1 + Web App + Easy Auth + acrPull via AVM
    ‚îî‚îÄ‚îÄ static-web-app.bicep    DELETE (deferred to Phase 18.9 cleanup)
```

| Module                | AVM Source                                                        | Version                | Purpose                             |
| --------------------- | ----------------------------------------------------------------- | ---------------------- | ----------------------------------- |
| log-analytics.bicep   | `br/public:avm/res/operational-insights/workspace`                | `0.15.0`               | Log Analytics Workspace (unchanged) |
| app-insights.bicep    | `br/public:avm/res/insights/component`                            | `0.7.1`                | Application Insights (unchanged)    |
| cosmos-account.bicep  | `br/public:avm/res/document-db/database-account`                  | `0.18.0`               | Cosmos DB Serverless (unchanged)    |
| cosmos-rbac.bicep     | Native `Microsoft.DocumentDB` resource                            | ‚Äî                      | Cosmos Data Contributor (unchanged) |
| **acr.bicep**         | `br/public:avm/res/container-registry/registry`                   | **`0.10.0`**           | Azure Container Registry Basic      |
| **app-service.bicep** | `br/public:avm/res/web/serverfarm` + `br/public:avm/res/web/site` | **`0.7.0` + `0.21.0`** | ASP B1 Linux + Web App + Easy Auth  |

---

## Implementation Tasks

### Task 1: Create `infra/modules/acr.bicep` (NEW)

**Purpose**: Provision an Azure Container Registry (Basic tier) for the HackerBoard container image.

**Parameters**:

| Parameter  | Type     | Description       | Source in `main.bicep`  |
| ---------- | -------- | ----------------- | ----------------------- |
| `name`     | `string` | ACR resource name | `var acrName` (derived) |
| `location` | `string` | Azure region      | `param location`        |
| `tags`     | `object` | Governance tags   | `var tags`              |

**AVM Module**: `br/public:avm/res/container-registry/registry:0.10.0`

**Key Configuration**:

```bicep
module containerRegistry 'br/public:avm/res/container-registry/registry:0.10.0' = {
  params: {
    name: name
    location: location
    tags: tags
    acrSku: 'Basic'
    publicNetworkAccess: 'Enabled'
    anonymousPullEnabled: false
    acrAdminUserEnabled: false
  }
}
```

**Outputs**:

| Output           | Type     | Description           |
| ---------------- | -------- | --------------------- |
| `acrName`        | `string` | ACR resource name     |
| `acrLoginServer` | `string` | ACR login server FQDN |
| `acrResourceId`  | `string` | ACR resource ID       |

---

### Task 2: Create `infra/modules/app-service.bicep` (NEW)

**Purpose**: Provision App Service Plan (B1 Linux) + Web App for Linux Containers with system-assigned managed identity, Easy Auth (GitHub OAuth), app settings, and `acrPull` role assignment.

**Parameters**:

| Parameter                     | Type               | Description                          | Source in `main.bicep`                  |
| ----------------------------- | ------------------ | ------------------------------------ | --------------------------------------- |
| `planName`                    | `string`           | App Service Plan name                | `var aspName` (derived)                 |
| `siteName`                    | `string`           | Web App name                         | `var appName` (derived)                 |
| `location`                    | `string`           | Azure region                         | `param location`                        |
| `tags`                        | `object`           | Governance tags                      | `var tags`                              |
| `acrLoginServer`              | `string`           | ACR login server FQDN                | `acr.outputs.acrLoginServer`            |
| `acrName`                     | `string`           | ACR resource name (for acrPull role) | `acr.outputs.acrName`                   |
| `containerImage`              | `string`           | Container image ref (`repo:tag`)     | `param containerImage`                  |
| `cosmosEndpoint`              | `string`           | Cosmos DB HTTPS endpoint             | `cosmosAccount.outputs.accountEndpoint` |
| `appInsightsConnectionString` | `string`           | App Insights connection string       | `appInsights.outputs.connectionString`  |
| `gitHubOAuthClientId`         | `@secure() string` | GitHub OAuth App client ID           | `param gitHubOAuthClientId`             |
| `gitHubOAuthClientSecret`     | `@secure() string` | GitHub OAuth App client secret       | `param gitHubOAuthClientSecret`         |

**Sub-resources**:

#### 2a. App Service Plan (AVM `serverfarm:0.7.0`)

```bicep
module appServicePlan 'br/public:avm/res/web/serverfarm:0.7.0' = {
  params: {
    name: planName
    location: location
    tags: tags
    kind: 'Linux'
    reserved: true
    skuName: 'B1'
    skuCapacity: 1
  }
}
```

#### 2b. Web App for Containers (AVM `site:0.21.0`)

```bicep
module webApp 'br/public:avm/res/web/site:0.21.0' = {
  params: {
    name: siteName
    location: location
    tags: tags
    kind: 'app,linux,container'
    serverFarmResourceId: appServicePlan.outputs.resourceId
    managedIdentities: {
      systemAssigned: true
    }
    httpsOnly: true
    siteConfig: {
      linuxFxVersion: 'DOCKER|${acrLoginServer}/${containerImage}'
      acrUseManagedIdentityCreds: true
      alwaysOn: true
      ftpsState: 'Disabled'
      minTlsVersion: '1.2'
      http20Enabled: true
    }
    appSettingsKeyValuePairs: {
      COSMOS_ENDPOINT: cosmosEndpoint
      APPLICATIONINSIGHTS_CONNECTION_STRING: appInsightsConnectionString
      WEBSITES_PORT: '8080'
      DOCKER_REGISTRY_SERVER_URL: 'https://${acrLoginServer}'
      GITHUB_OAUTH_CLIENT_SECRET: gitHubOAuthClientSecret
    }
    authSettingV2Configuration: {
      platform: {
        enabled: true
        runtimeVersion: '~1'
      }
      globalValidation: {
        unauthenticatedClientAction: 'RedirectToLoginPage'
        redirectToProvider: 'github'
      }
      identityProviders: {
        gitHub: {
          registration: {
            clientId: gitHubOAuthClientId
            clientSecretSettingName: 'GITHUB_OAUTH_CLIENT_SECRET'
          }
        }
      }
      login: {
        tokenStore: {
          enabled: true
        }
      }
    }
  }
}
```

> [!WARNING]
> **Easy Auth Risk (R1)**: The AVM `web/site:0.21.0` `authSettingV2Configuration` parameter schema may not perfectly align with the ARM `Microsoft.Web/sites/config@2024-04-01` schema. If the AVM module rejects the auth config, **fallback**: create a separate native `Microsoft.Web/sites/config` child resource with `name: 'authsettingsV2'` after the AVM module deploys the site. See [Risks & Considerations](#risks--considerations).

#### 2c. ACR Pull Role Assignment (Native Bicep)

The `acrPull` role (GUID: `7f951dda-4ed3-4680-a7ca-43fe172d538d`) grants the App Service MI permission to pull container images from ACR without admin credentials.

```bicep
resource acr 'Microsoft.ContainerRegistry/registries@2023-07-01' existing = {
  name: acrName
}

resource acrPullRoleAssignment 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(acr.id, webApp.outputs.systemAssignedMIPrincipalId, '7f951dda-4ed3-4680-a7ca-43fe172d538d')
  scope: acr
  properties: {
    roleDefinitionId: subscriptionResourceId(
      'Microsoft.Authorization/roleDefinitions',
      '7f951dda-4ed3-4680-a7ca-43fe172d538d'
    )
    principalId: webApp.outputs.systemAssignedMIPrincipalId
    principalType: 'ServicePrincipal'
  }
}
```

**Outputs**:

| Output                  | Type     | Description                              |
| ----------------------- | -------- | ---------------------------------------- |
| `appServiceHostname`    | `string` | Default hostname (`*.azurewebsites.net`) |
| `appServiceName`        | `string` | Web App resource name                    |
| `appServicePrincipalId` | `string` | System-assigned MI principal ID          |
| `appServiceResourceId`  | `string` | Web App resource ID                      |
| `appServicePlanId`      | `string` | App Service Plan resource ID             |

---

### Task 3: Update `infra/main.bicep` (MODIFY)

**Purpose**: Replace SWA module with ACR + App Service modules; update parameter flow and outputs.

#### 3a. Parameters ‚Äî Add

| Parameter                 | Type               | Default                 | Description                              |
| ------------------------- | ------------------ | ----------------------- | ---------------------------------------- |
| `gitHubOAuthClientId`     | `@secure() string` | _(required)_            | GitHub OAuth App client ID for Easy Auth |
| `gitHubOAuthClientSecret` | `@secure() string` | _(required)_            | GitHub OAuth App client secret           |
| `containerImage`          | `string`           | `'hacker-board:latest'` | Container image reference (`repo:tag`)   |

#### 3b. Parameters ‚Äî Remove

| Parameter          | Reason                               |
| ------------------ | ------------------------------------ |
| `repositoryUrl`    | SWA-specific (GitHub source linkage) |
| `repositoryBranch` | SWA-specific                         |

#### 3c. Parameters ‚Äî Modify

| Parameter  | Change                                                                                                        |
| ---------- | ------------------------------------------------------------------------------------------------------------- |
| `location` | Update `@description` to remove SWA region requirement; keep `@allowed` or widen for App Service availability |

#### 3d. Variables ‚Äî Add

```bicep
// ACR: alphanumeric only, 5-50 chars, CAF abbreviation 'cr'
var acrName = 'cr${replace(projectName, '-', '')}${environment}'

// App Service Plan: CAF abbreviation 'asp'
var aspName = 'asp-${suffix}'

// Web App: CAF abbreviation 'app'
var appName = 'app-${suffix}'
```

#### 3e. Modules ‚Äî Remove

```bicep
// DELETE entire block:
module staticWebApp 'modules/static-web-app.bicep' = { ... }
```

#### 3f. Modules ‚Äî Add

```bicep
// Phase 3: Container Registry
module acr 'modules/acr.bicep' = {
  name: 'acr-${deploymentTimestamp}'
  params: {
    name: acrName
    location: location
    tags: tags
  }
}

// Phase 4: Compute ‚Äî App Service with container + Easy Auth
module appService 'modules/app-service.bicep' = {
  name: 'app-service-${deploymentTimestamp}'
  params: {
    planName: aspName
    siteName: appName
    location: location
    tags: tags
    acrLoginServer: acr.outputs.acrLoginServer
    acrName: acr.outputs.acrName
    containerImage: containerImage
    cosmosEndpoint: cosmosAccount.outputs.accountEndpoint
    appInsightsConnectionString: appInsights.outputs.connectionString
    gitHubOAuthClientId: gitHubOAuthClientId
    gitHubOAuthClientSecret: gitHubOAuthClientSecret
  }
}
```

#### 3g. Cosmos RBAC ‚Äî Update caller

```bicep
module cosmosRbac 'modules/cosmos-rbac.bicep' = {
  name: 'cosmos-rbac-${deploymentTimestamp}'
  params: {
    cosmosAccountName: cosmosAccount.outputs.accountName
    principalId: appService.outputs.appServicePrincipalId  // was: staticWebApp.outputs.principalId
  }
}
```

#### 3h. Outputs ‚Äî Replace

| Remove           | Add                     | Type     |
| ---------------- | ----------------------- | -------- |
| `swaHostname`    | `appServiceHostname`    | `string` |
| `swaName`        | `appServiceName`        | `string` |
| `swaPrincipalId` | `appServicePrincipalId` | `string` |
| ‚Äî                | `acrLoginServer`        | `string` |
| ‚Äî                | `acrName`               | `string` |

---

### Task 4: Update `infra/main.bicepparam` (MODIFY)

**Changes**:

```bicep-params
using 'main.bicep'

param projectName = 'hacker-board'
param environment = 'prod'
param location = 'centralus'
param owner = 'agentic-infraops'
param costCenter = 'microhack'
param technicalContact = 'jonathan@lordofthecloud.eu'
param application = 'hacker-board'
param workload = 'web-app'
param sla = 'non-production'
param backupPolicy = 'none'
param maintWindow = 'any'

// NEW: Container image (updated by CI/CD after first push)
param containerImage = 'hacker-board:latest'

// NEW: GitHub OAuth credentials ‚Äî supply at deploy time, NEVER commit secrets
// param gitHubOAuthClientId = <provide via --parameters override>
// param gitHubOAuthClientSecret = <provide via --parameters override>

// REMOVED: repositoryUrl, repositoryBranch (SWA-specific)
```

> [!IMPORTANT]
> `gitHubOAuthClientId` and `gitHubOAuthClientSecret` are `@secure()` parameters. They **must** be supplied at deployment time via `--parameters` CLI override or Key Vault reference. They must **never** appear in `.bicepparam` files committed to source control.

---

### Task 5: Rebuild `infra/azuredeploy.json`

```bash
az bicep build --file infra/main.bicep --outfile infra/azuredeploy.json
```

> [!CAUTION]
> The Portal "Deploy to Azure" button reads `azuredeploy.json`. Skipping this step causes stale parameter defaults. Always commit `main.bicep` and `azuredeploy.json` together.

---

## Deployment Phases

> Deployment strategy: **Phased** (4 phases ‚Äî matching existing deployment pattern)

### Phase 1: Foundation (NO CHANGE ‚Äî Already Deployed)

| Order | Module              | Resources               | Validation                                |
| ----- | ------------------- | ----------------------- | ----------------------------------------- |
| 1     | log-analytics.bicep | Log Analytics Workspace | `az monitor log-analytics workspace show` |
| 2     | app-insights.bicep  | Application Insights    | Connection string in outputs              |

**Status**: ‚úÖ Already deployed ‚Äî no changes required.

### Phase 2: Data Layer (NO CHANGE ‚Äî Already Deployed)

| Order | Module               | Resources                             | Validation                  |
| ----- | -------------------- | ------------------------------------- | --------------------------- |
| 3     | cosmos-account.bicep | Cosmos DB Account + DB + 6 Containers | Account endpoint in outputs |

**Status**: ‚úÖ Already deployed ‚Äî no changes required.

### Phase 3: Container Registry (NEW)

| Order | Module    | Resources                | Validation                                       |
| ----- | --------- | ------------------------ | ------------------------------------------------ |
| 4     | acr.bicep | Azure Container Registry | `az acr show --name <acrName>`, login server URL |

**Approval Gate**: Verify ACR is accessible and login server resolves before proceeding.

### Phase 4: Compute + Auth + RBAC (NEW)

| Order | Module            | Resources                                             | Validation                                       |
| ----- | ----------------- | ----------------------------------------------------- | ------------------------------------------------ |
| 5     | app-service.bicep | App Service Plan + Web App + MI + Easy Auth + acrPull | `az webapp show`, hostname resolves, MI assigned |
| 6     | cosmos-rbac.bicep | Cosmos DB Data Contributor ‚Üí App Service MI           | `az cosmosdb sql role assignment list`           |

**Approval Gate**: Verify App Service is running, Easy Auth responds at `/.auth/me`, and Cosmos RBAC is assigned.

### Phase Summary

| Phase | Resources     | Est. Deploy Time | Approval Gate | Status              |
| ----- | ------------- | ---------------- | ------------- | ------------------- |
| 1     | 2 (unchanged) | 0 min (skip)     | ‚úÖ Deployed   | ‚úÖ Already deployed |
| 2     | 1 (unchanged) | 0 min (skip)     | ‚úÖ Deployed   | ‚úÖ Already deployed |
| 3     | 1 (new)       | ~3 min           | ‚úÖ            | ‚¨ú Todo             |
| 4     | 3 (new + mod) | ~5 min           | ‚úÖ            | ‚¨ú Todo             |

---

## Dependency Graph

![Module Dependency Graph](./04-dependency-diagram.png)

Source: [04-dependency-diagram.py](./04-dependency-diagram.py)

### Parameter Flow

```text
main.bicep (orchestrator)
‚îÇ
‚îú‚îÄ‚Üí logAnalytics (name, location, tags)
‚îÇ       ‚îî‚îÄ‚Üí outputs: workspaceId
‚îÇ
‚îú‚îÄ‚Üí appInsights (name, location, tags, workspaceResourceId ‚Üê logAnalytics)
‚îÇ       ‚îî‚îÄ‚Üí outputs: connectionString
‚îÇ
‚îú‚îÄ‚Üí cosmosAccount (name, location, tags)
‚îÇ       ‚îî‚îÄ‚Üí outputs: accountEndpoint, accountName
‚îÇ
‚îú‚îÄ‚Üí acr (name, location, tags)
‚îÇ       ‚îî‚îÄ‚Üí outputs: acrLoginServer, acrName, acrResourceId
‚îÇ
‚îú‚îÄ‚Üí appService (planName, siteName, location, tags,
‚îÇ               acrLoginServer ‚Üê acr, acrName ‚Üê acr,
‚îÇ               containerImage, cosmosEndpoint ‚Üê cosmosAccount,
‚îÇ               appInsightsConnectionString ‚Üê appInsights,
‚îÇ               gitHubOAuthClientId, gitHubOAuthClientSecret)
‚îÇ       ‚îú‚îÄ‚Üí [internal] App Service Plan (ASP B1 Linux)
‚îÇ       ‚îú‚îÄ‚Üí [internal] Web App for Containers (MI + Easy Auth + app settings)
‚îÇ       ‚îú‚îÄ‚Üí [internal] acrPull role assignment (App Service MI ‚Üí ACR)
‚îÇ       ‚îî‚îÄ‚Üí outputs: appServiceHostname, appServiceName, appServicePrincipalId
‚îÇ
‚îî‚îÄ‚Üí cosmosRbac (cosmosAccountName ‚Üê cosmosAccount, principalId ‚Üê appService)
```

---

## Runtime Flow Diagram

![Runtime Flow Diagram](./04-runtime-diagram.png)

Source: [04-runtime-diagram.py](./04-runtime-diagram.py)

---

## Naming Conventions

| Resource               | Pattern                       | Generated Name             | Max Length |
| ---------------------- | ----------------------------- | -------------------------- | ---------- |
| Resource Group         | `rg-{project}-{env}`          | `rg-hacker-board-prod`     | 90         |
| Log Analytics          | `law-{project}-{env}`         | `law-hacker-board-prod`    | 63         |
| Application Insights   | `appi-{project}-{env}`        | `appi-hacker-board-prod`   | 255        |
| Cosmos DB Account      | `cosmos-{project}-{env}`      | `cosmos-hacker-board-prod` | 44         |
| **Container Registry** | `cr{project-no-hyphens}{env}` | `crhackerboardprod`        | 50         |
| **App Service Plan**   | `asp-{project}-{env}`         | `asp-hacker-board-prod`    | 40         |
| **Web App**            | `app-{project}-{env}`         | `app-hacker-board-prod`    | 60         |

> [!NOTE]
> ACR names must be **alphanumeric only** (no hyphens). The `cr` prefix follows CAF abbreviation conventions. All names are well within their max length limits.

---

## Security Configuration

| Resource         | Security Setting           | Value                              | Rationale                                  |
| ---------------- | -------------------------- | ---------------------------------- | ------------------------------------------ |
| ACR              | Admin user                 | `disabled`                         | MI-based pull, no shared credentials       |
| ACR              | Anonymous pull             | `disabled`                         | Private images only                        |
| ACR              | Public network access      | `Enabled`                          | Required for CI/CD push + App Service pull |
| App Service Plan | SKU                        | `B1` (Linux)                       | Cost-effective for non-production          |
| Web App          | HTTPS only                 | `true`                             | Enforce TLS                                |
| Web App          | Minimum TLS version        | `1.2`                              | Security baseline                          |
| Web App          | FTPS state                 | `Disabled`                         | No FTP access                              |
| Web App          | HTTP/2                     | `Enabled`                          | Performance                                |
| Web App          | Always On                  | `true`                             | Prevent cold starts                        |
| Web App          | System-assigned MI         | `Enabled`                          | For ACR pull + Cosmos RBAC                 |
| Web App          | ACR MI-based pull          | `acrUseManagedIdentityCreds: true` | No admin credentials                       |
| Web App          | Easy Auth                  | `Enabled` (GitHub provider)        | Same `/.auth/*` contract as SWA            |
| Web App          | Unauthenticated action     | `RedirectToLoginPage`              | Require auth by default                    |
| Web App          | Token store                | `Enabled`                          | Required for `/.auth/me` endpoint          |
| Cosmos DB RBAC   | Role                       | Built-in Data Contributor          | Least privilege for read/write data-plane  |
| ACR Pull Role    | `acrPull` (`7f951dda-...`) | App Service MI                     | Pull-only access, no push                  |
| Tags             | 9 governance tags          | All present                        | B3 policy compliance                       |

### Role Assignments Summary

| Principal      | Role                                | Scope             | Purpose               |
| -------------- | ----------------------------------- | ----------------- | --------------------- |
| App Service MI | `acrPull`                           | ACR resource      | Pull container images |
| App Service MI | Cosmos DB Built-in Data Contributor | Cosmos DB account | Read/write data-plane |

### Governance Compliance

| Constraint                  | Status       | Notes                                                         |
| --------------------------- | ------------ | ------------------------------------------------------------- |
| B3 ‚Äî 9 RG tags              | ‚úÖ Compliant | Already in `main.bicep`, tag inheritance auto-propagates      |
| B5 ‚Äî MCAPSGov deny policies | ‚úÖ Compliant | App Service + ACR not in deny list                            |
| B6 ‚Äî Storage key auth deny  | ‚úÖ Compliant | ACR uses Azure-managed storage, not customer storage accounts |
| Cosmos `disableLocalAuth`   | ‚úÖ Compliant | `DefaultAzureCredential` + MI ‚Äî no connection strings         |
| MFA on resource write (B1)  | ‚úÖ Compliant | Operational ‚Äî deployer authenticates with MFA                 |
| Tag inheritance (Modify)    | ‚úÖ Compliant | Policy auto-copies 9 tags from RG to child resources          |

---

## Risks & Considerations

### R1: Easy Auth `authSettingV2Configuration` Schema Compatibility (Medium Risk)

The AVM `web/site:0.21.0` module accepts `authSettingV2Configuration` as a typed parameter, but the exact schema may not perfectly align with the ARM `Microsoft.Web/sites/config@2024-04-01` schema for `authsettingsV2`.

**Mitigation**: During Bicep Code implementation, test with `az bicep build` first. If the AVM module rejects the auth config:

- **Fallback**: Create a separate native `Microsoft.Web/sites/config` child resource with `name: 'authsettingsV2'` using the `parent` property or `existing` reference to the AVM-deployed site.

### R2: Container Image Not Available on First Deploy (Low Risk)

During initial infrastructure provisioning, the ACR will be empty ‚Äî no container image exists yet. The Web App will show a startup error until CI/CD pushes the first image.

**Mitigation**: Accept the startup error for initial deployment (infrastructure-only Phase 18.4). The image gets pushed in Phase 18.5 (CI/CD pipeline). Alternatively, set `linuxFxVersion` to a known public placeholder like `DOCKER|mcr.microsoft.com/appsvc/staticsite:latest` and update after first push.

### R3: GitHub OAuth Callback URL Timing (Low Risk)

The GitHub OAuth App callback URL must be `https://app-hacker-board-prod.azurewebsites.net/.auth/login/github/callback`. This URL is only valid after deployment, but the OAuth App must be configured beforehand.

**Mitigation**: Hostname is deterministic from naming convention: `app-{project}-{env}.azurewebsites.net`. Pre-create the GitHub OAuth App with this value (Step 10 in migration plan).

### R4: ACR Basic Tier Limitations (Low Risk)

ACR Basic tier provides 10 GiB storage and limited throughput. Sufficient for a single-image hackathon app.

**Mitigation**: Monitor ACR storage. Upgrade to Standard via a simple `acrSku` parameter change if needed.

### R5: `@secure()` Parameters in `.bicepparam` (Operational)

`gitHubOAuthClientId` and `gitHubOAuthClientSecret` cannot be committed to `.bicepparam`. They must be supplied at deploy time.

**Mitigation**: `deploy.ps1` must accept these as CLI parameters or read from Key Vault. For CI/CD, store as GitHub Actions secrets and pass via `--parameters` override.

### R6: AVM `web/site` `siteConfig` vs `appSettingsKeyValuePairs` (Low Risk)

The AVM `web/site` module may use `appSettingsKeyValuePairs` (key-value object) or `siteConfig.appSettings` (array of `{name, value}` objects) ‚Äî the handling may differ between AVM versions.

**Mitigation**: During preflight check (04-preflight-check), validate the exact AVM parameter names via `mcp_bicep_get_az_resource_type_schema`. Adjust configuration style to match the AVM module's expected input.

---

## Estimated Implementation Time

| Task                              | Estimated Duration |
| --------------------------------- | ------------------ |
| `modules/acr.bicep` (new)         | 15 minutes         |
| `modules/app-service.bicep` (new) | 45 minutes         |
| `main.bicep` updates              | 30 minutes         |
| `main.bicepparam` updates         | 10 minutes         |
| AVM schema validation + lint      | 20 minutes         |
| `az bicep build` + testing        | 15 minutes         |
| `what-if` dry run                 | 15 minutes         |
| **Total**                         | **~2.5 hours**     |

---

## Approval Gate

> [!IMPORTANT]
> **üìã Implementation Plan Ready ‚Äî Phase 18.4**
>
> | Metric                           | Value                                                        |
> | -------------------------------- | ------------------------------------------------------------ |
> | Azure resources planned          | 8 (3 new, 1 modified, 4 unchanged)                           |
> | Bicep modules to create          | 2 (`acr.bicep`, `app-service.bicep`)                         |
> | Bicep modules to modify          | 1 (`main.bicep`)                                             |
> | AVM modules used                 | 3 new (`registry:0.10.0`, `serverfarm:0.7.0`, `site:0.21.0`) |
> | Governance constraints addressed | ‚úÖ All 6 verified                                            |
> | CAF naming conventions applied   | ‚úÖ                                                           |
> | Deployment strategy              | Phased (4 phases ‚Äî Phases 1‚Äì2 already deployed)              |
> | Est. Implementation              | ~2.5 hours                                                   |
>
> - [ ] **Approved** ‚Äî proceed to bicep-code
> - **Approver**: ******\_\_\_******
> - **Date**: ******\_\_\_******
>
> Reply **"approve"** to proceed to bicep-code, or provide feedback.

---

## References

> [!NOTE]
> üìö The following Microsoft Learn resources inform this implementation.

| Topic                     | Link                                                                                                                                                    |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Azure Verified Modules    | [AVM Index](https://aka.ms/avm/index)                                                                                                                   |
| Bicep Best Practices      | [Documentation](https://learn.microsoft.com/azure/azure-resource-manager/bicep/best-practices)                                                          |
| CAF Naming Conventions    | [Naming Rules](https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/resource-naming)                                   |
| Resource Abbreviations    | [Abbreviations](https://learn.microsoft.com/azure/cloud-adoption-framework/ready/azure-best-practices/resource-abbreviations)                           |
| App Service Easy Auth     | [Authentication](https://learn.microsoft.com/azure/app-service/overview-authentication-authorization)                                                   |
| App Service + ACR MI Pull | [ACR Pull with MI](https://learn.microsoft.com/azure/app-service/configure-custom-container#use-managed-identity-to-pull-from-azure-container-registry) |
| AVM Container Registry    | [AVM ACR Module](https://github.com/Azure/bicep-registry-modules/tree/main/avm/res/container-registry/registry)                                         |
| AVM Web Serverfarm        | [AVM ASP Module](https://github.com/Azure/bicep-registry-modules/tree/main/avm/res/web/serverfarm)                                                      |
| AVM Web Site              | [AVM Site Module](https://github.com/Azure/bicep-registry-modules/tree/main/avm/res/web/site)                                                           |
| Easy Auth GitHub Provider | [GitHub Provider](https://learn.microsoft.com/azure/app-service/configure-authentication-provider-github)                                               |

---

_Plan generated by bicep-plan agent following Azure Well-Architected Framework guidelines._

---

| ‚¨ÖÔ∏è [04-governance-constraints.md](04-governance-constraints.md) | üè† [Project Index](README.md) | ‚û°Ô∏è [04-preflight-check.md](04-preflight-check.md) |
| --------------------------------------------------------------- | ----------------------------- | ------------------------------------------------- |
